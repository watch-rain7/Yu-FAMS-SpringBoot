<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.example.mapper.InventoryMapper">

    <sql id="Base_Column_List">
        id, code, inventory_time, result, asset_id, operator_id, create_time
    </sql>

    <select id="selectAll" resultType="com.example.entity.Inventory">
        select
        i.*, a.name as assetName, a.no as assetCode, s.name as operatorName
        from inventory i
        left join assets a on i.asset_id = a.id
        left join staff s on i.operator_id = s.id
        <where>
            <if test="code != null">
                AND i.code LIKE CONCAT('%', #{code}, '%')
            </if>
            <if test="result != null">
                AND i.result = #{result}
            </if>
            <if test="assetId != null">
                AND i.asset_id = #{assetId}
            </if>
            <if test="operatorId != null">
                AND i.operator_id = #{operatorId}
            </if>
        </where>
        order by i.id desc
    </select>

    <select id="selectById" resultType="com.example.entity.Inventory">
        select
        i.*, a.name as assetName, a.no as assetCode, s.name as operatorName
        from inventory i
        left join assets a on i.asset_id = a.id
        left join staff s on i.operator_id = s.id
        where i.id = #{id}
    </select>

    <delete id="deleteById">
        delete from inventory
        where id = #{id}
    </delete>

    <insert id="insert" parameterType="com.example.entity.Inventory" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO inventory(
            code, inventory_time, result, asset_id, operator_id, create_time
        ) VALUES (
                     #{code}, #{inventoryTime}, #{result}, #{assetId}, #{operatorId}, #{createTime}
                 )
    </insert>

    <update id="updateById" parameterType="com.example.entity.Inventory">
        update inventory
        <set>
            <if test="code != null">
                code = #{code},
            </if>
            <if test="inventoryTime != null">
                inventory_time = #{inventoryTime},
            </if>
            <if test="result != null">
                result = #{result},
            </if>
            <if test="assetId != null">
                asset_id = #{assetId},
            </if>
            <if test="operatorId != null">
                operator_id = #{operatorId},
            </if>
        </set>
        where id = #{id}
    </update>

    <select id="selectStats" resultType="com.example.entity.Inventory">
        SELECT 
            DATE_FORMAT(inventory_time, '%Y-%m') as month,
            COUNT(*) as count,
            SUM(CASE WHEN result = '正常' THEN 1 ELSE 0 END) as normalCount,
            SUM(CASE WHEN result = '异常' THEN 1 ELSE 0 END) as abnormalCount
        FROM inventory 
        WHERE inventory_time >= DATE_SUB(CURDATE(), INTERVAL 6 MONTH)
        GROUP BY DATE_FORMAT(inventory_time, '%Y-%m')
        ORDER BY month DESC
    </select>

</mapper> 